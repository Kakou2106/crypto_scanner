name: Quantum Scanner 24/7

on:
  schedule:
    - cron: '0 */6 * * *'  # toutes les 6 heures
  workflow_dispatch:        # possibilité de lancer manuellement
  push:
    branches: [main]

jobs:
  scan-crypto:
    runs-on: ubuntu-latest
    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      COINLIST_API_KEY: ${{ secrets.COINLIST_API_KEY }}
      KUCOIN_API_KEY: ${{ secrets.KUCOIN_API_KEY }}
      LUNARCRUSH_API_KEY: ${{ secrets.LUNARCRUSH_API_KEY }}
      DUNE_API_KEY: ${{ secrets.DUNE_API_KEY }}
      ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
      BSCSCAN_API_KEY: ${{ secrets.BSCSCAN_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      MAX_MARKET_CAP_EUR: 100000
      SCAN_INTERVAL_HOURS: 6

    steps:
      - uses: actions/checkout@v3
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip list | grep aiosqlite
      - name: Generate .env file
        run: |
          echo "TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}" > .env
          echo "TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}" >> .env
          echo "COINLIST_API_KEY=${{ secrets.COINLIST_API_KEY }}" >> .env
          echo "KUCOIN_API_KEY=${{ secrets.KUCOIN_API_KEY }}" >> .env
          echo "LUNARCRUSH_API_KEY=${{ secrets.LUNARCRUSH_API_KEY }}" >> .env
          echo "DUNE_API_KEY=${{ secrets.DUNE_API_KEY }}" >> .env
          echo "ETHERSCAN_API_KEY=${{ secrets.ETHERSCAN_API_KEY }}" >> .env
          echo "BSCSCAN_API_KEY=${{ secrets.BSCSCAN_API_KEY }}" >> .env
          echo "GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}" >> .env
          echo "MAX_MARKET_CAP_EUR=100000" >> .env
          echo "SCAN_INTERVAL_HOURS=6" >> .env
      - name: Create data directory
        run: mkdir -p data
      - name: Run Quantum Scanner
        run: |
          # S’assure que le script charge .env dans ton code (load_dotenv()), 
          # puis exécute le
          python quantum_scanner.py --once
      - name: Upload DB artifact
        uses: actions/upload-artifact@v4
        with:
          name: quantum_scanner_db
          path: data/quantum_scanner.db
          retention-days: 30
